<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CMA Segregation of Duties Map</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { font-size: 1.5em; }
  table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #f4f4f4; }
  .high { background-color: #ffb3b3; }
  .moderate { background-color: #ffd9b3; }
  .safe { background-color: #d9ffd9; }
  .tooltip { position: relative; display: inline-block; cursor: pointer; }
  .tooltip .tooltiptext {
    visibility: hidden;
    background-color: black; color: #fff;
    text-align: left; padding: 5px; border-radius: 4px;
    position: absolute; z-index: 1;
    bottom: 125%; left: 50%; margin-left: -120px; width: 240px;
  }
  .tooltip:hover .tooltiptext { visibility: visible; }
  button { margin-right: 8px; margin-bottom: 8px; }
  .name-btn { background: none; border: none; cursor: pointer; font-weight: bold; }
  .legend { margin: 10px 0; }
  .legend span { padding: 4px 8px; border-radius: 4px; margin-right: 10px; color: #000; }
</style>
</head>
<body>

<h1>CMA Exam ‚Äì Segregation of Duties (SoD) Map</h1>

<div>
  <button onclick="addPerson()">‚ûï Add Person</button>
  <button onclick="resetAssignments()">‚ôª Reset</button>
  <button onclick="exportCSV()">üìÑ Export CSV</button>
  <button onclick="toggleMode()">üéØ Toggle Study/Exam Mode</button>
</div>

<div class="legend">
  <strong>Legend:</strong>
  <span style="background-color:#d9ffd9;">üü¢ Safe</span>
  <span style="background-color:#ffd9b3;">üü† Moderate Risk</span>
  <span style="background-color:#ffb3b3;">üî¥ High Risk</span>
</div>

<div id="tableContainer"></div>

<script>
const cycles = {
  "Revenue / Cash Receipts": [
    "Authorize credit sales", "Record receivables", "Receive cash/checks",
    "Deposit cash", "Reconcile bank"
  ],
  "Expenditure / Cash Disbursements": [
    "Approve purchase orders", "Receive goods", "Approve vendor invoices",
    "Record payables", "Sign checks / authorize payments", "Reconcile bank"
  ],
  "Payroll": [
    "Add/modify employee master file", "Approve time worked", "Process payroll",
    "Distribute paychecks", "Reconcile payroll account"
  ],
  "Inventory": [
    "Approve purchase requisitions", "Receive goods into inventory",
    "Record inventory transactions", "Approve write-offs",
    "Reconcile inventory records to physical counts"
  ],
  "Fixed Assets": [
    "Approve capital projects", "Record acquisitions/disposals",
    "Perform depreciation/amortization", "Physical verification of assets"
  ],
  "Treasury / Financing": [
    "Arrange financing", "Manage investments", "Debt servicing",
    "Cash flow forecasting"
  ],
  "Financial Reporting & Closing": [
    "Prepare adjusting entries", "Approve journal entries",
    "Prepare financial statements", "Review & approve filings"
  ]
};

// High-risk conflict pairs
const conflicts = [
  ["Receive cash/checks", "Reconcile bank"],
  ["Authorize credit sales", "Record receivables"],
  ["Approve vendor invoices", "Sign checks / authorize payments"],
  ["Add/modify employee master file", "Distribute paychecks"],
  ["Receive goods into inventory", "Approve write-offs"],
  ["Record inventory transactions", "Reconcile inventory records to physical counts"],
  ["Deposit cash", "Reconcile bank"],
  ["Record payables", "Sign checks / authorize payments"],
  ["Process payroll", "Approve time worked"],
  ["Approve capital projects", "Record acquisitions/disposals"],
  ["Arrange financing", "Manage investments"],
  ["Prepare adjusting entries", "Approve journal entries"]
];

let people = ["Person 1", "Person 2"];
let assignments = {};
let studyMode = true;

function renderTable() {
  let html = "<table><tr><th>Task</th>";
  people.forEach((p, idx) => {
    html += `<th>
      <button class="name-btn" onclick="renamePerson(${idx})">${p}</button>
      <button onclick="removePerson(${idx})" title="Remove ${p}">‚ùå</button>
    </th>`;
  });
  html += "</tr>";
  for (const cycle in cycles) {
    html += `<tr><th colspan="${people.length+1}" style="background:#ddd">${cycle}</th></tr>`;
    cycles[cycle].forEach(task => {
      html += `<tr><td>${task}</td>`;
      people.forEach(p => {
        const assigned = assignments[p]?.includes(task);
        let riskClass = "safe";
        let tooltip = "";
        if (assigned && studyMode) {
          const conflictsFound = checkConflicts(p, task);
          if (conflictsFound.high.length) {
            riskClass = "high";
            tooltip = conflictsFound.high.join(", ");
          } else if (conflictsFound.moderate) {
            riskClass = "moderate";
            tooltip = "Multiple duties in same cycle";
          }
        }
        html += `<td class="${riskClass}" onclick="toggleAssign('${p}','${task}')">
          <div class="tooltip">${assigned ? "‚úî" : ""}
            ${tooltip ? `<span class="tooltiptext">${tooltip}</span>` : ""}
          </div>
        </td>`;
      });
      html += "</tr>";
    });
  }
  html += "</table>";
  document.getElementById("tableContainer").innerHTML = html;
}

function toggleAssign(person, task) {
  assignments[person] = assignments[person] || [];
  if (assignments[person].includes(task)) {
    assignments[person] = assignments[person].filter(t => t !== task);
  } else {
    assignments[person].push(task);
  }
  renderTable();
}

function checkConflicts(person, task) {
  let high = [];
  let moderate = false;
  const assignedTasks = assignments[person] || [];
  assignedTasks.forEach(t => {
    conflicts.forEach(([a, b]) => {
      if ((t === a && task === b) || (t === b && task === a)) {
        high.push(`Conflict: ${a} & ${b}`);
      }
    });
  });
  for (const cycle in cycles) {
    const tasksInCycle = cycles[cycle];
    const count = assignedTasks.filter(t => tasksInCycle.includes(t)).length;
    if (count >= 3) moderate = true;
  }
  return { high, moderate };
}

function addPerson() {
  const name = prompt("Enter person's name:");
  if (name) {
    people.push(name);
    renderTable();
  }
}

function removePerson(index) {
  if (confirm(`Remove ${people[index]}?`)) {
    const name = people[index];
    delete assignments[name];
    people.splice(index, 1);
    renderTable();
  }
}

function renamePerson(index) {
  const newName = prompt("Enter new name:", people[index]);
  if (newName && newName.trim() !== "") {
    const oldName = people[index];
    people[index] = newName.trim();
    assignments[newName] = assignments[oldName] || [];
    delete assignments[oldName];
    renderTable();
  }
}

function resetAssignments() {
  assignments = {};
  renderTable();
}

function exportCSV() {
  let csv = "Task," + people.join(",") + "\n";
  for (const cycle in cycles) {
    cycles[cycle].forEach(task => {
      const row = [task];
      people.forEach(p => {
        row.push(assignments[p]?.includes(task) ? "X" : "");
      });
      csv += row.join(",") + "\n";
    });
  }
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "SoD_Assignments.csv";
  a.click();
}

function toggleMode() {
  studyMode = !studyMode;
  renderTable();
}

renderTable();
</script>

</body>
</html>
